# Insta-helper
Данный проект разворачивает облачную инфраструктуру для web-приложения, работающего в docker-контейнере.  
Здесь содержится набор инструкций расчитаный на использование облачного провайдера Yandex cloud. Ознакомиться с требованиями и инструкциями данного облачного провайдера можно на официальном сайте: <https://yandex.cloud/ru/>  
Управление и развертывание ресурсов производится при помощи Terraform <https://yandex.cloud/ru/docs/tutorials/infrastructure-management/terraform-quickstart#linux_1>.

## Необходимый софт
Для работы с данным проектом необходимо предварительно установить следующие инструменты в систему:
 - Terraform <https://developer.hashicorp.com/terraform/install>
 - Ansible <https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-and-upgrading-ansible>
 - Любой редактор кода 

## Развертывание проекта. 
В папке проекта имеются 3 поддиректории **infra**, **service** и **webapp**. В директории infra содержатся файлы для работы с инфраструктурой - продуктовое и тестовое окружение. В директории service файлы для работы с шаблонным сервисом приложения и в поддиректории **webapp** лежат файлы самого приложения.

Для развертывания сервиса необходимо пройти следующие этапы:
1. Перейти по пути **#root_folder#/infra/prod(testing)/terraform/** и ввести следующие команды: `terraform init` (для инициализации в текущей директории провайдера услуг тераформ) и затем `terraform apply` для запуска процесса создания облачных ресурсов (продуктового и/или тестового окружения). 
По окончании процесса в облаке будут созданы:  
- Сервер приложения (тестовый и "рабочий") (внешние IP-адреса которых будет автоматически занесены в hosts-в данном проекте)
- Сервер для установки и работы Gitlab-раннера. (Для сборки образов проекта.)
- Серверы мониторинга для тестового и продуктового окружения
- Серверы для установки Grafana для тестового и продуктового окружения
- Балансировщик нагрузки
- Днс-записи для связи балансировщика и домена (**домен должен быть зарегестрирован заранее**)
- Сеть и подсети (разные для тестового и продуктового окружения)
В случае необходимости внести какие либо изменения в структуру создаваемых ресурсов, первым делом проверьте файл **vars.tf**. В этом файле содержатся переменные из которых состоит конфигурация инфраструктуры.  
2. Перейти по пути **#root_folder#/infra/prod(testing)/ansible/** и ввести следующие команды: `ansible-playbook deploy_stage1.yml`.  
На этом этапе на созданых ранее серверах приложения будет установлен докер и все необходимые для его работы зависимости.  
Таким образом будет подготовлена инфраструктура для развертывания приложения.
3. Перейти по пути **#root_folder#/infra/prod(testing)/ansible/PrometheusWithGrafana** и ввести следующие команды: `ansible-playbook deploy_monitoring.yml`. Данная команда развернет систему мониторинга на необходимом окружении. Будет установлен Prometheus, Grafana, node-exporters на все ВМ для снятия метрик, а так же cAdvisor для мониторинга приложения в контейнере.
4. На этом этапе на ВМ отведенной для раннера, устанавливается и регистрируется собственно сам раннер.  
В своем кабинете на Gitlab в репозитории своего приложения (в нашем случае Webapp), нужно в по пути Settings/CI/CD/Runners скопировать "registration token" и внести его в переменную **reg_token** файла **#root_folder#/service/ansible/vars.yml**. Данную процедуру нужно будет проделывать каждый раз при регистрации нового раннера. После этого необходимо перейти по пути **#root_folder#/service/ansible/** и ввести команду: `ansible-playbook install_runner`. Данный сценарий установит на ВМ все необходимое ПО для установки, запуска и регистрации Gitlab-раннера. 
4. Директория **service** так же содержит файлы приложения, и поддиректорию **ansible_export** в которой находятся сценарий ансибл с шаблоном сервиса и файл для запуска пайплайна **.gitlab-ci.yml** в котором описан этапы сборки образов приложения при помощи раннера. В этом файле в переменных **DOCKER_CONTAINER_NAME и DOCKERHUB_USERNAME** необходимо задать имя создаваемого контейнера и логин на Докерхабе(для авторизации) соответственно.
 Еще в данном репозитории в Setting/CI/CD/Variables необходимо создать и заполнить следующие переменные проекта:
 - **Docker_Hub_Pass** - пароль от докерхаба
 - **SSH_PRIVATE_KEY** - секретный ssh-ключ (необходимо создать заранее) 
 - **SSH_USER** - пользователь для авторизации на удаленных серверах (в нашем случает на тестовой и "рабочей" машинах) к которым будет подключаться раннер.


## Состав папки проекта.
``` markdown
/  
    infra/
        prod/                   (директория для с необходимыми файлами для развертывания продуктового окружения)
            ansible/  
                ansible.cfg     (файл конфигурации ansible)  
                deploy_stage1.yml  (плейбук для установки докер на сервер приложения)  
                hosts           (файл серверов и их адресов для ansible. Создается автоматически терраформом)  
                vars.yml        (файл с переменными)
                PrometheusWithGrafana/   (директория с ролью для развертывания мониторинга)
                     roles/
                        alertmanager/   (файлы,необходимые для установки менеджера уведомлений)
                        cAdvisor/       (файлы,необходимые для установки cAdvisor)
                        grafana/        (файлы,необходимые для установки Графаны)
                        prometheus/     (файлы,необходимые для установки Прометеуса)
                        prometheus_node_exporter/   (файлы,необходимые для установки нодэкспортеров)
            terraform/  
                main.tf         (файл терраформ для развертывания инфраструктуры)  
                vars.tf         (файл терраформ содержащий все переменные)  
        
        testing/                (директория для с необходимыми файлами для развертывания тестового окружения)
            ansible/  
                ansible.cfg     (файл конфигурации ansible)  
                deploy_stage1.yml  (плейбук для установки докер на сервер приложения)  
                hosts           (файл серверов и их адресов для ansible. Создается автоматически терраформом)  
                vars.yml        (файл с переменными)
                PrometheusWithGrafana/   (директория с ролью для развертывания мониторинга)
                     roles/
                        alertmanager/   (файлы,необходимые для установки менеджера уведомлений)
                        cAdvisor/       (файлы,необходимые для установки cAdvisor)
                        grafana/        (файлы,необходимые для установки Графаны)
                        prometheus/     (файлы,необходимые для установки Прометеуса)
                        prometheus_node_exporter/   (файлы,необходимые для установки нодэкспортеров)
            terraform/  
                main.tf         (файл терраформ для развертывания инфраструктуры)  
                vars.tf         (файл терраформ содержащий все переменные) 

    service/  
        ansible/  
            ansible.cfg     (файл конфигурации ansible)  
            install-runner.yml  (сценарий для установки Gitlab-раннера)  
            hosts           (файл серверов и их адресов для ansible. Создается автоматически терраформом)  
            vars.yml        (файл с переменными)  
            ansible_export/
                ansible.cfg     (файл конфигурации ansible)
                hosts           (файл серверов и их адресов для ansible. Создается автоматически терраформом) 
                deploy_pBook.yml    (файл сценария запуска сервиса приложения)
                web-app.service.j2  (Шаблон юнит-файла сервиса приложения)
        webapp/                     (директория проекта приложения)        

```
## Состав серверов.
Prod - окружение:
    - Сервер приложения продакшен "prod-server"
    - Сервер с раннером "git-runner" (работает на оба окружения)
    - Сервер мониторинга "monitoring"
    - Сервер  с графаной "grafana"

Test - окружение:    
    - Сервер приложения тестовый "test-server"
    - Сервер мониторинга "monitoring-testing"
    - Сервер  с графаной "grafana-testing"